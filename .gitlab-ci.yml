stages:
  - test
  - build_frontend
  - build_backend
  - build_images
  - push_images
  - deploy_minikube

variables:
  FRONT_DIR: "frontend"
  BACK_DIR: "back"
  DOCKER_HOST: tcp://docker:2375
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  DOCKER_IMAGE_BACKEND: "bayremboussaidi/backend"
  DOCKER_IMAGE_FRONTEND: "bayremboussaidi/front"

# Run Backend Tests
run_backend_tests:
  stage: test
  image: maven:3.9.6-eclipse-temurin-21
  script:
    - echo "Running backend tests..."
    - cd back
    - mvn test -DskipTests=false
    - echo "Backend tests completed"
  artifacts:
    reports:
      junit: back/target/surefire-reports/TEST-*.xml
    paths:
      - back/target/surefire-reports/
    expire_in: 1 week

# Run Frontend Tests
run_frontend_tests:
  stage: test
  image: node:18
  script:
    - echo "Running frontend tests..."
    - cd frontend
    - npm install --legacy-peer-deps
    - npm test -- --watch=false --browsers=ChromeHeadless
    - echo "Frontend tests completed"
  artifacts:
    paths:
      - frontend/coverage/
    expire_in: 1 week

# Build Angular Frontend
build_angular_frontend:
  stage: build_frontend
  image: node:18
  script:
    - echo "Installing dependencies and building Angular app..."
    - cd $FRONT_DIR
    - npm install --legacy-peer-deps
    - npm run build -- --configuration=production
  artifacts:
    paths:
      - frontend/dist/
    expire_in: 1 week
  cache:
    paths:
      - frontend/node_modules/

# Build Backend
build_backend:
  stage: build_backend
  image: maven:3.9.6-eclipse-temurin-21
  script:
    - echo "Installing backend dependencies and building the Spring Boot app..."
    - cd $BACK_DIR
    - mvn clean package -DskipTests=true
  artifacts:
    paths:
      - back/target/
    expire_in: 1 week

# Build Docker Images
build_docker_images:
  stage: build_images
  image: docker:20.10.16
  services:
    - name: docker:20.10.16-dind
      command: ["--host=tcp://0.0.0.0:2375"]
  script:
    - echo "Building Docker images..."
    - docker build -t $DOCKER_IMAGE_BACKEND:$CI_COMMIT_SHA -t $DOCKER_IMAGE_BACKEND:latest ./back
    - docker build -t $DOCKER_IMAGE_FRONTEND:$CI_COMMIT_SHA -t $DOCKER_IMAGE_FRONTEND:latest ./frontend
    - echo "All Docker images built successfully"
  dependencies:
    - build_angular_frontend
    - build_backend

# Push Images to Docker Hub
push_docker_images:
  stage: push_images
  image: docker:20.10.16
  services:
    - name: docker:20.10.16-dind
      command: ["--host=tcp://0.0.0.0:2375"]
  script:
    - echo "Logging into Docker Hub..."
    - echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
    - echo "Pushing backend image..."
    - docker push $DOCKER_IMAGE_BACKEND:$CI_COMMIT_SHA
    - docker push $DOCKER_IMAGE_BACKEND:latest
    - echo "Pushing frontend image..."
    - docker push $DOCKER_IMAGE_FRONTEND:$CI_COMMIT_SHA
    - docker push $DOCKER_IMAGE_FRONTEND:latest
    - echo "All images pushed to Docker Hub successfully"
  dependencies:
    - build_docker_images
  only:
    - main
    - master

# Deploy to Minikube
deploy_to_minikube:
  stage: deploy_minikube
  image: bitnami/kubectl:latest
  before_script:
    - echo "Setting up Minikube deployment..."
    - curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
    - install minikube-linux-amd64 /usr/local/bin/minikube
    - minikube start --driver=docker --force
    - minikube addons enable ingress
    - echo "Minikube started successfully"
  script:
    - echo "Deploying application to Minikube..."
    - kubectl apply -f k8s/namespace.yaml
    - kubectl apply -f k8s/mysql-deployment.yaml
    - kubectl wait --for=condition=ready pod -l app=mysql -n car-rent-app --timeout=300s || echo "MySQL not ready"
    - #sed -i "s|image:.*backend.*|image: ${DOCKER_IMAGE_BACKEND}:latest|g" k8s/backend-deployment.yaml
    - #sed -i "s|image:.*frontend.*|image: ${DOCKER_IMAGE_FRONTEND}:latest|g" k8s/frontend-deployment.yaml
    - kubectl apply -f k8s/backend-deployment.yaml
    - kubectl apply -f k8s/frontend-deployment.yaml
    - kubectl apply -f k8s/ai-chatbot-deployment.yaml
    - echo "Deployment Status:"
    - kubectl get pods -n car-rent-app
    - kubectl get svc -n car-rent-app
    - echo "Deployment completed successfully"
  dependencies:
    - push_docker_images
  only:
    - main
    - master
  environment:
    name: minikube